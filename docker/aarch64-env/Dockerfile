# Use a Debian base image
FROM ubuntu:22.04 as builder

# Install build dependencies and cross-compilers
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    make \
    wget \
    ca-certificates \
    perl \
    zip \
    unzip \
    curl \
    openssl \
    libssl-dev \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

# Add cargo to PATH
ENV PATH="/root/.cargo/bin:${PATH}"

# Add aarch64 target
RUN rustup target add aarch64-unknown-linux-gnu
RUN rustup default stable

## Install aws
RUN  curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" \
    && unzip awscliv2.zip \
    && ./aws/install

# Check installation
RUN aws --version

# Set environment for cross-compilation
ENV AARCH64_OPENSSL_VERSION=openssl-3.0.8
ENV AARCH_OPENSSL_DIR=/usr/local/openssl-aarch64

# Download and extract OpenSSL
WORKDIR /tmp/${AARCH64_OPENSSL_VERSION}
RUN wget https://www.openssl.org/source/${AARCH64_OPENSSL_VERSION}.tar.gz \
    && tar -xzf ${AARCH64_OPENSSL_VERSION}.tar.gz \
    && cd ${AARCH64_OPENSSL_VERSION} \
    && ./Configure linux-aarch64 no-shared --prefix=${AARCH_OPENSSL_DIR} --cross-compile-prefix=aarch64-linux-gnu- \
    && make \
    && make install
